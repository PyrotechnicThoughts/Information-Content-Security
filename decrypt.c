#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <openssl/evp.h>
#include <openssl/err.h>
#include <openssl/hmac.h>
#include <openssl/sha.h>

#include "decrypt.h"

#define OUTPUT_LEN 104

const char *key_expansion_str = "key expansion";

void p_hash(const unsigned char *secret, size_t secret_len,
            const unsigned char *seed, size_t seed_len,
            unsigned char *output, size_t output_len)
{

    unsigned char A[SHA256_DIGEST_LENGTH];
    unsigned char temp[SHA256_DIGEST_LENGTH + seed_len];
    int current_len = 0;

    // Initial A = HMAC(secret, seed)
    HMAC(EVP_sha256(), secret, secret_len, seed, seed_len, A, NULL);

    while (current_len < output_len)
    {
        // Prepare temp = A + seed
        memcpy(temp, A, SHA256_DIGEST_LENGTH);
        memcpy(temp + SHA256_DIGEST_LENGTH, seed, seed_len);

        // HMAC(secret, temp)
        HMAC(EVP_sha256(), secret, secret_len, temp, SHA256_DIGEST_LENGTH + seed_len, temp, NULL);

        // Copy to output
        int to_copy = output_len - current_len;
        if (to_copy > SHA256_DIGEST_LENGTH)
        {
            to_copy = SHA256_DIGEST_LENGTH;
        }
        memcpy(output + current_len, temp, to_copy);
        current_len += to_copy;

        // Update A = HMAC(secret, A)
        HMAC(EVP_sha256(), secret, secret_len, A, SHA256_DIGEST_LENGTH, A, NULL);
    }
}

/**
 * ciphertext：指向加密后的数据的指针
 * ciphertext_len：加密后的数据的长度
 * key：指向AES密钥的指针
 * nonce：指向随机生成的nonce（用于初始化向量）的指针
 * add：指向附加认证数据的指针。在GCM模式中，这些数据将被用于认证，但不会被解密
 * add_len：附加认证数据的长度
 * auth_tag：指向加密时生成的认证标签的指针。在解密时，用于验证密文的完整性和真实性
 * auth_tag_len：认证标签的长度
 * plaintext：用于存储解密后的数据的缓冲区
 */

int decrypt_aes_128_gcm(const unsigned char *ciphertext, int ciphertext_len,
                        const unsigned char *key,
                        const unsigned char *nonce,
                        unsigned char *plaintext)
{
    EVP_CIPHER_CTX *ctx;
    int len, plaintext_len;

    if (!(ctx = EVP_CIPHER_CTX_new()))
    {
        printf("Error creating new context\n");
        return -1;
    }

    if (!EVP_DecryptInit_ex(ctx, EVP_aes_128_gcm(), NULL, NULL, NULL))
    {
        printf("Error initializing decryption\n");
        return -1;
    }

    if (!EVP_CIPHER_CTX_ctrl(ctx, EVP_CTRL_GCM_SET_IVLEN, NONCE_LENGTH, NULL))
    {
        printf("Error setting IV length\n");
        return -1;
    }

    if (!EVP_DecryptInit_ex(ctx, NULL, NULL, key, nonce))
    {
        printf("Error setting key and nonce\n");
        return -1;
    }

    if (!EVP_DecryptUpdate(ctx, plaintext, &len, ciphertext, ciphertext_len))
    {
        printf("Error updating with ciphertext\n");
        return -1;
    }
    plaintext_len = len;

    EVP_CIPHER_CTX_free(ctx);

    return plaintext_len;
}

int generate(tls_session_info *session, tls_record_info *record)
{
    memcpy((session->hash_secret), session->pre_master_secret, HASH_SECRET_LENGTH);

    unsigned char temp_buffer[HASH_SEED_LENGTH];
    memcpy(temp_buffer, KEY_EXPANSION_HEX, 13);
    memcpy(temp_buffer + 13, session->server_random, SERVER_RANDOM_LENGTH);
    memcpy(temp_buffer + 13 + SERVER_RANDOM_LENGTH, session->client_random, CLIENT_RANDOM_LENGTH);

    memcpy(session->hash_seed, temp_buffer, HASH_SEED_LENGTH);

    p_hash(session->hash_secret, HASH_SECRET_LENGTH, session->hash_seed, HASH_SEED_LENGTH, session->hash_out, HASH_OUT_LENGTH);

    memcpy(session->prf_out, session->hash_out, PRF_OUT_LENGTH);
    memcpy(session->key_expansion, session->hash_out, KEY_EXPANSION_LENGTH);

    memcpy(session->client_key, session->key_expansion, CLIENT_KEY_LENGTH);
    memcpy(session->server_key, session->key_expansion + CLIENT_KEY_LENGTH, SERVER_KEY_LENGTH);

    memcpy(session->client_iv, session->key_expansion + CLIENT_KEY_LENGTH + SERVER_KEY_LENGTH, CLIENT_IV_LENGTH);
    memcpy(session->server_iv, session->key_expansion + CLIENT_KEY_LENGTH + SERVER_KEY_LENGTH + CLIENT_IV_LENGTH, SERVER_IV_LENGTH);

    return 1;
}

#ifdef MAIN_DECRYPT

int main()
{
    const unsigned char key[] = "\x82\x12\x22\x17\xab\x0b\x5e\x62\x34\xC6\xA5\xE7\x08\x66\x87\x76";                                                                                                                                                                                                                                // 16 bytes AES key
    const unsigned char nonce[] = "\x00\x5d\x6a\xf9\x00\x00\x00\x00\x00\x00\x00\x01";                                                                                                                                                                                                                                              // 12 bytes nonce
    const unsigned char ciphertext[] = "\x76\x31\x87\x39\x87\xaf\x8a\xa4\x5c\xe2\x2b\xa6\x94\xca\xfe\x5f\xab\x44\x43\x66\x0e\xc0\xb9\xd2\x06\xb6\x0d\x86\x99\x4d\x9c\xa8\xff\xb0\xc5\xf1\x3a\xe7\x20\xf9\x02\xbd\x73\x4c\x85\xe7\xc5\x40\x5e\x98\x24\xde\x5f\xad\xac\xf0\x63\x5e\xea\xa1\x28\x36\x08\xab\xc5\x6b\x80\x6b\x23\x3e"; // Encrypted text

    int ciphertext_len = sizeof(ciphertext) - 1;
    unsigned char plaintext[4096];

    tls_session_info session;
    tls_record_info record;

    memcpy(session.client_key, key, CLIENT_KEY_LENGTH);

    record.ciphertext = (u_char *)malloc(ciphertext_len * sizeof(u_char));
    record.ciphertext_length = ciphertext_len;
    memcpy(record.ciphertext, ciphertext, record.ciphertext_length);
    memcpy(record.nonce, nonce, NONCE_LENGTH);

    record.plaintext_length = 0;
    record.plaintext = (u_char *)malloc(PLAINTEXT_LENGTH * sizeof(u_char));

    record.plaintext_length = decrypt_aes_128_gcm(record.ciphertext, record.ciphertext_length, session.client_key, record.nonce, record.plaintext);
    if (record.plaintext_length < 0)
    {
        printf("Decryption failed");
        return 1;
    }
    for (int i = 0; i < record.plaintext_length; ++i)
    {
        printf("%02x", record.plaintext[i]);
    }
    printf("\n");

    free(record.ciphertext);
    free(record.plaintext);

    const unsigned char ciphertext_1[] = "\xb6\x77\x38\x0b\x2b\x3c\xba\xba\x1f\xca\xdc\x8e\x02\x72\x48\x59\x80\x47\x42\x27\x02\x68\x9e\xb2\x51\xd6\xaf\x33\x65\x6c\x3b\x7a\x0a\xb8\xcc\xf9\x86\xe2\x90\xa9\xf0\x06\x15\x11\x26\xf4\x32\x9e\x4d\x68\xad\x0f\xf4\xb0\x44\x39\x19\x41\x38\x24\x11\x71\xb7\x15\x01\xe7\x16\xeb\xce\x93\xb3\x68\xc0\xdd\x8e\x89\xe2\xa3\x26\xf4\xae\x00\xff\xab\x4b\x70\xac\x84\x7e\x72\xea\xde\xf7\x20\xf5\xfc\x47\x84\x38\xb4\xf7\x54\x50\x16\x95\x7f\x16\x9c\x6e\xe5\x19\x21\x43\xca\x45\x25\x45\xa8\xf0\xb9\x7f\x36\xdb\x80\xaa\x86\xd3\x04\x8c\xd5\xe0\xa9\xb1\x6b\x7b\x58\x6b\xb3\x8d\x7e\x3b\x5d\x35\x80\x78\x94\x20\x88\x6f\xfc\xcf\xc9\x91\x8e\xc3\x2f\xa5\xc9\xe2\x9b\x17\xd4\xda\x32\x77\x2c\x91\xa3\x0c\x1b\x56\x05\x91\x01\xc5\xd8\x4f\x3a\x96\x14\x09\xc4\xbc\x67\xb8\x16\x3f\x60\x39\x95\x4e\xda\xd2\x94\xdc\xfc\x09\x63\x22\x16\x4a\xfa\x7b\xe0\x4c\x0b\x7c\xef\x46\x50\x64\x85\x6d\xf9\xac\x7f\xac\xd0\xb5\xbc\x1b\x8d\x05\x3b\x19\x31\x9c\xb1\x7a\xfd\x78\xb3\x5f\xb3\xe6\x09\x08\xa8\xdf\x5c\xd5\x90\x68\x14\xfa\x13\x79\xe6\x67\xe4\x75\xd2\x15\x50\x85\x71\x39\x0f\x44\x50\xdb\x5c\x3d\x0a\x64\xd1\x52\x77\x4f\xe9\xbd\xd5\xf6\xd6\x11\x41\x62\x61\xbf\xa3\x89\xf3\x23\x05\x80\xfc\xf1\xcd\x30\x95\xd1\x00\x2e\x26\x07\xa7\xb3\x39\x5c\x71\x22\x9e\x04\xe0\x18\x60\x65\x6e\x95\x2f\x98\x09\x15\x03\xa8\x4d\xff\xaf\xec\x0e\x55\x32\x5f\xf3\xc6\x7b\xcf\x0a\x83\xe0\x52\x95\xd5\x50\x09\x67\xaf\x5f\xc4\x6a\xe8\x04\x24\x42\xcf\x78\x55\xad\xaa\x98\x87\xc1\xae\xf2\xbc\x33\x18\xa8\xb6\x01\x90\xeb\x78\xf7\xfc\x0d\x4e\xe3\xb3\x8c\x97\xee\xcc\x57\xd0\xf1\x53\x11\x69\x3b\xb6\xaf\x48\xcc\xd5\x4c\x9a\xe5\x75\xe9\xf1\x68\x1b\x97\x7e\xe1\xb4\x91\x85\xd1\xc3\x1e\xd7\xb0\x86\xc3\x8c\x5b\x3c\xf2\x2d\xd2\xf6\x07\x06\xf5\x01\xd5\xf2\xc5\xd0\x3a\x44\x3d\x41\x8f\x04\xd3\x30\xe1\x31\xa3\x4f\xf6\x65\x46\xb7\xbf\x0e\xd2\xf4\x1f\xea\x48\x4e\x65\x9f\xa1\xe6\x97\x3c\xe3\x5a\x57\xba\x7a\x49\x26\x17\x95\x44\x6b\x18\xde\x02\x2e\xf5\x63\x20\x19\xcc\x6a\x41\xe3\x30\xd3\x99\x25\x3c\x39\xf5\xd7\xb0\x71\xa0\xd1\xbf\xfb\x5b\x33\xb4\x81\x9d\x7a\xd4\xc9\xae\x2d\x85\x4a\xe9\xdf\x73\x75\x13\x57\x57\xfc\xb6\x15\x40\x5d\x26\x0b\xc5\xd3\x6e\xc2\xfb\x38\x60\x62\x95\x8d\xc6\xd8\x32\x46\xf8\xbf\x0b\x59\x77\x4d\x1f\x14\x29\x78\x9a\xfc\x61\x0b\x8d\x22\x1c\x66\x43\x78\x7d\xf1\x43\x4e\xbd\x7a\xa2\x74\xa7\xf6\xdf\x09\xda\x7a\x4f\x30\x83\x95\x42\x5d\x26\x93\xfd\x6b\xde\xfd\x1a\x8e\x63\xa8\x5f\x15\x60\xcd\xbb\xb6\xdb\x8b\xd4\xcf\x7c\xb1\x8e\x5e\xd8\xab\x1d\x56\x19\xaa\x8b\x8c\x27\xea\x4f\xbb\xbc\x71\xfe\xaf\x04\x7b\x75\x60\xcb\xf7\x34\x35\x7a\x10\x96\xd3\x5e\xb4\x32\xbf\xf1\x02\xa5\xf2\x76\x95\x5c\x81\xd3\x3d\x62\x37\xc8\xe6\x1c\xdf\xc4\xc9\x7f\x47\x62\x61\x03\x1b\xf2\x55\x9f\xae\x9e\x54\xed\x09\x1d\x62\x01\xa7\x70\xab\xb9\x6a\xe3\x4d\x5d\x38\x00\x52\x91\x09\x77\xf1\x4f\x8d\x08\xdc\x8e\xab\xc9\xb9\xbc\x52\x9e\xd9\x76\x56\xbb\xcf\xb1\xc7\x77\x19\x48\xa5\x16\x44\xf5\xdc\x27\x23\xc5\x78\xbd\xca\xa2\x4b\xac\x16\x27\x8b\x11\x3d\x25\x7d\xdf\x9d\xd9\x55\xc3\x15\xed\xfe\x43\x07\x8f\xa2\xfe\xcc\x86\xe4\xcc\x49\xcb\x0e\x6a\xc2\xa9\xbd\x85\xc6\xc1\xdd\x34\x35\xbf\x8b\x6b\xbc\xac\x7b\x4a\x77\x81\x2b\x0c\x37\x25\xee\xdd\x9b\xc0\x22\x9e\x8a\x83\x55\x84\xc9\x35\x0c\x45\x40\xf4\xe1\x4a\xfa\xda\xc1\x43\x0b\x93\xf5\xb6\x7e\x45\xb5\x83\xd1\x9f\x49\xaf\x4f\x4e\x10\xae\x94\x15\x37\xc0\x83\x83\x12\x3f\x46\x06\xa2\xda\x5d\x9f\xc9\xfd\xa2\x5c\x54\x73\xe3\xc6\xa0\xf5\x0f\x79\x34\xf4\x99\x39\x75\xa0\x3d\x43\x62\xdd\x90\xe7\x7b\x7b\x9b\xa0\x50\x04\x12\x59\xe3\xe5\x26\xa4\xa8\x37\x32\x14\x0e\x6b\x52\x15\xcf\x68\xc5\x38\x9d\xac\xc0\x5d\x1b\x3c\x9e\x5a\x59\x90\x74\x1f\x6f\xca\x2b\x3c\x59\x52\x5e\xbc\x62\xf9\xd2\xb7\x01\x90\x32\xb2\xce\x12\xbc\x0f\xa0\x7b\xfc\x3c\x46\xd4\x5d\xf7\xe8\x51\x4d\x72\x6f\xd7\x53\xb7\xff\x1e\x29\x53\xa8\xf9\x02\xa2\x8c\x88\xce\x75\xc6\x1e\x83\xef\x29\x23\x94\x4e\xc1\xab\xbb\x85\xe9\x04\x0c\x64\xa4\x27\x6b\x31\x62\xd9\x16\xeb\x5a\x3b\x96\x29\xab\xdb\x0e\x0e\xb8\x6b\x38\xc0\x24\x6a\x71\xcc\xf6\x99\x1c\x7c\x32\xca\x94\x52\x1f\x5e\xd8\x3d\x2d\x0a\xe8\xe4\x82\xd7\x0c\x30\x4a\xd1\x25\x20\x22\x5a\xe4\xc9\x57\x7d\x90\xb5\xae\x35\xd9\xeb\x84\xe7\x9a\x30\x7f\x05\x9e\xa2\xdf\x86\xec\xaa\xcf\x10\xef\xaa\x0a\xa2\x6a\xac\x0e\xe2\xcc\x7f\x96\x92\x87\xa7\x3b\x19\xa8\x5e\x2d\x35\xfc\xb5\x36\x4f\x86\x8c\x13\x12\x76\xc7\xc6\x86\x14\x8e\x98\x4c\xb3\xfb\xe2\x73\x87\x3d\x2b\x3a\xfa\xe0\x07\xa3\xa2\x81\x20\xa6\x1c\x90\x74\xea\xdc\x01\x66\x8e\x42\x5f\x7b\x04\x90\xbe\x05\x5e\x70\x55\x8d\x91\x80\x98\x9c\x8a\x65\x46\xb7\x31\x38\x3f\x03\xec\xc0\x5a\x42\x24\x49\xf8\x2e\xa7\x6f\xea\x6d\x15\x6d\xe7\xb0\xdc\xa8\xf4\x41\x8b\x4a\x37\xec\x58\x28\x0d\x9e\xb5\x1e\x5a\x77\xec\x3e\x64\x71\x44\xa6\xe7\x11\x0d\x8e\xf0\x52\x30\xda\xc3\xb3\xc0\x0f\xce\x03\xe4\xe0\x77\xc5\x59\xea\xef\x62\x74\x04\x02\x07\x7f\x35\x57\x48\xb4\x5f\x20\xa1\x42\x6e\x07\x49\xf2\x2e\xcc\xe3\xdb\x33\x3c\x14\x1e\xef\x49\x1a\x07\x1e\xcd\x18\x03\x27\x45\x52\xa9\xa3\x55\x32\x0e\x66\x3f\x6a\x74\x65\xb4\xa8\x1b\x67\x75\xf3\x10\xec\x1d\xad\xdf\x2f\xd7\x5c\xc2\xce\x80\xdb\x44\x13\xcf\xfd\xee\x54\x21\xd3\x09\x96\x91\x75\x36\x25\xf9\xc7\xd2\x79\xea\xd1\x29\xe7\xd4\x24\xa1\x9a\x4a\x70\xce\x28\x50\x0b\xbb\x46\x23\xd5\x7a\x56\xa3\xa7\x4d\x51\xa6\x07\x11\x77\xdd\x2f\x40\x02\x1c\xaf\xce\xf2\x8c\xa0\x5d\xf8\xc4\xc9\xcd\x72\xac\x19\x5f\x7a\x87\x01\x69\xf7\xa5\x8d\xd9\x32\x22\xb8\x87\xdc\x4f\x61\xac\xcc\xb4\x01\xa1\x8f\x3b\x1b\xb5\x73\x00\x63\x11\x91\x6d\x21\xa4\xe9\x99\x13\xb9\x7d\xd6\xdd\xd8\x09\x4e\xe4\xb6\x5b\xa9\xe3\x14\xec\x34\x65\x20\x82\x21\xcb\x41\xf9\xba\x84\x3d\x7e\x8d\x81\xa7\x71\xfb\xa1\xc7\x56\xe0\xd9\xe7\xc2\xae\x98\x72\x0c\x9d\x95\x7d\x2b\xe8\x51\x36\xd9\x9a\x5e\x0f\x18\x53\x7c\x59\x94\x57\x8a\xca\x97\xed\x22\x30\xca\x34\x43\x2b\x24\x34\xe0\xc1\xb5\xad\x27\x95\x0d\xe7\xd9\x53\x8a\xe7\xfb\x6f\x9c\xc4\xa1\x54\xd3\x41\x91\x45\xc2\xd7\xbe\xae\xec\xd7\xc3\x56\xad\xa3\xe0\x81\xd4\x6f\x47\xd3\x95\xa5\x96\x30\x34\x81\x8d\xc6\x3a\x20\x84\xd1\x6d\x61\x36\x05\xa7\x62\x3a\x13\x7d\xab\x81\x54\xbf\xe3\xf8\x63\xa9\xc1\xed\x64\x98\xc7\xcd\xee\x2c\x7c\xa4\x34\xe9\xc7\x84\x27\x10\xcc\x63\x0f\xa8\xfa\x3f\x26\x91\x02\xef\x58\xf9\x0a\xbb\x4e\x34\x85\x30\x2f\xb4\xf5\x37\xf2\x16\x8d\x64\xac\x92\xc7\x84\xe2\x46\xbc\xbb\x3d\x3b\xd4\x61\x63\xeb\xa3\x53\x76\x52\xd0\x47\x81\x65\x9b\xba\x62\x5c\xff\x57\xf5\xc7\x00\x69\x59\x57\x40\x25\x7d\x4c\x1f\xad\xc8\x18\xd6\x22\x56\x95\xcc\x69\xb7\xeb\x2d\x00\xfa\xd9\xb5\x58\xf5\x94\x38\xe5\x7c\x9a\xa7\x19\xc5\xbe\xb4\x58\x15\x8d\xa7\xa0\x62\xc6\xcb\x0e\x0e\x61\x1e\x5f\xc1\xcb\xaa\xfc\xb2\x04\xa8\x4c\x46\xbd\xd1\x7d\xcd\x67\xb5\xdd\x10\x92\x00\x28\x5c\x95\x58\xca\xf7\xdb\x0d\x61\x56\x2a\x83\x30\x55\xe3\x42\x60\x40\x74\x7a\x06\xed\xb7\x06\xcc\xc5\x0d\xb0\x07\x51\xfa\xbb\x79\x34\xc1\xf5\xcc\x7c\x26\x5b\xc0\x45\x2c\x2e\x38\x62\x69\xe0\x8e\xb8\x62\x2f\x50\xeb\xe3\x07\x8b\x0d\x86\x0f\x6e\x5e\xb1\x62\xdb\xbf\x03\x22\x8c\x69\x9f\xd7\xef\x60\x91\x7b\x11\x1e\xdb\x5c\x10\x2b\x20\xf6\x15\x55\x56\x79\xce\xe3\xdb\x24\x6b\x03\xaf\x44\xa4\xc8\xa5\x2a\x21\xfa\x6d\x56\xdc\x77\xc5\x3f\x9b\x6b\x24\x3c\x22\xb0\x9a\x73\x9c\x7f\x13\xea\x72\x90\x28\xcf\xda\xe0\xbf\x32\xf2\x37\xbd\xce\x0c\xee\x6f\x37\x8e\x64\x1d\x66\xd3\x42\x7d\x59\x5c\x77\x77\xe0\x7c\x57\x75\xe5\x47\x03\xcd\x89\x4a\xbf\x0e\x91\x37\xf4\x57\xa1\xc3\x00\x98\x25\xd5\xe5\x64\x72\x19\xdd\xee\xc5\xb0\xc4\xc6\xb0\x0d\xd9\xb0\x6e\xbe\xae\xac\x09\x43\xc2\x85\x75\x26\x0f\x71\x15\xa8\x47\x05\xb5\x00\x2d\x36\x61\x01\x2b\x8f\xfd\x34\x14\x29\x79\xe8\x2d\xc1\x37\xf3\x20\x58\x7c\x2b\x5c\x47\xb0\xf5\x76\x48\xf6\xff\xcf\xd4\xc1\x5a\x89\xf1\x58\x12\xcc\x3d\x31\xb0\x58\xd4\x02\x88\xb8\xd6\x28\xf5\x29\x0d\xd6\x3a\xce\x93\x30\x25\x47\x4c\x9c\x71\x15\x1e\x3b\xb3\xbf\xd0\x12\x70\xe8\xb1\x9c\xab\x4a\xd2\x58\xc2\x1f\x96\x05\x7c\xb9\x0f\x2f\x4a\x83\xd7\x44\xa5\x5d\x9e\xd5\x49\xe7\x02\xbd\xf4\x1c\xe2\xb2\xcc\x14\x92\x9e\xea\xa6\x8b\x4b\xd5\xc2\xd4\x93\x64\x2b\xb3\x4f\x08\xe9\x2c\xe4\xe4\x59\x59\x1b\xdc\x51\xc8\x25\xdb\xd1\xf2\x69\x89\x6e\x4e\xe5\xf4\x1b\xc7\x3d\x3c\x8a\x8e\xec\x2d\xf9\x5f\x84\x1f\x8f\x8c\xf5\xd3\xd8\x2f\x24\x54\xab\xf6\x24\x56\x48\x7f\x5e\xd4\xb2\xb2\xe6\x8b\xb6\x78\x46\xdc\x76\xc8\x2a\x3d\x43\xb5\x55\x4c\x2b\xd3\x55\xde\x09\x8b\x20\x17\x67\x81\xf8\x22\xb2\x28\x6d\xd5\x72\xca\x52\x4f\x0c\x5e\xa9\x5f\x0d\x7a\x69\x6e\xab\xcc\x0f\x63\x01\x98\x82\xc8\x60\xac\x15\x97\x73\x6e\xa9\x86\x15\x19\x40\x04\x57\x3f\x06\x21\x4a\x97\x7f\x89\x02\x8b\x53\xdc\x3f\x18\xfb\x6a\xfc\x93\x3c\x3d\xbd\x9f\x95\x4f\xcd\xcd\x14\xe2\x4a\x44\xe1\x4a\x4e\xce\xeb\x8a\x6d\x31\xfd\x68\xb4\x37\x38\x79\xee\xf4\xf9\x67\x95\x61\x05\x8a\xf7\xd7\x5d\x61\x21\x4f\x10\x0b\x83\x67\xbd\x04\x32\x9a\x90\x20\xa3\x06\xe7\x60\x21\x76\xc0\x11\x81\x60\xcc\xbb\x44\x5e\x20\x23\x7d\x3e\xbb\x9e\x6f\x47\x48\x4b\xe2\x02\x9c\xfc\xf4\x7d\xbb\x76\x7a\x16\x6a\x05\xd5\xce\x81\x03\x20\x59\x56\x57\x43\xc9\xd6\xdc\x7c\x4c\xa4\x87\x4c\x1b\x38\x82\xf7\xe6\xb2\x91\xc2\xa9\x14\x5a\x96\x20\xbb\x16\xcd\x2c\x53\xe7\x8a\x54\x3d\x18\x61\x93\x11\x6f\xbe\xac\x88\x1d\x62\x03\x39\x4e\x97\xc8\x18\xe2\x52\x4f\x35\x78\x4c\xe7\x6f\x20\x49\x13\x5a\xc1\xe7\xdf\x9c\x90\x18\x55\xbf\xcd\xd8\x9d\x98\xd5\xa1\x04\xb2\x19\x7a\x06\x72\x07\xd6\x80\xc4\x57\xc5\xed\xd2\xcb\xbd\xd1\x9b\x29\x7c\x67\x39\x26\x19\xd1\x10\x81\xe5\x70\x53\x70\x94\x09\xf6\xf5\x31\x38\xdf\xe1\x16\xdd\x46\x50\x39\xa4\x35\xf9\x8f\x8c\x24\x35\x58\x60\xef\x7f\x98\xf1\xff\x2a\x55\x07\x9f\x1b\xdc\x35\xc9\xc3\x02\xef\x8d\x6a\xfb\xd7\x43\xf3\xf5\x8f\x49\x58\x32\xd7\x4f\x34\x2d\xa3\x1c\x3f\xc4\xfb\x34\x54\xce\xde\xc7\xd8\x25\xdd\xc5\xd3\x0e\x46\xd5\xfa\x01\x27\x3f\xe5\x8b\xc7\x0c\x55\x9f\x5a\x4f\x7d\xcf\x68\xad\x6d\x58\xe4\x2d\xa4\x5e\x50\xdc\x6f\x59\xdc\x44\x68\xe2\x19\x59\xc3\xfe\x27\xfa\x15\xd4\x6b\xd1\xcb\x0f\xb2\xd5\x0e\xed\xdb\x1b\xa7\xae\x01\xaf\xc8\x11\x3c\x57\x8e\xab\x51\xf6\x9e\xa4\x90\x57\x48\x4b\x53\x31\x9c\xef\xef\x0f\xc3\x26\x3f\xaf\xcd\x0c\x66\xc4\x49\x10\x02\xf9\x8f\x7f\x66\x56\x72\x39\x2c\xd6\x8e\x29\x99\x82\xfb\x7e\x3f\x21\x7a\x17\xe9\x00\x3f\xb6\x6d\xb1\x1c\xa4\xa6\xc7\xc4\x35\x3e\xf1\x31\xf6\xe1\xfc\x1d\xbe\x86\x2e\x59\x63\xb4\xe6\xaa\xcd\x8c\xab\x37\x61\x9b\x76\xae\x76\xb2\x94\x55\xbc\xfb\x7d\x1a\xe9\x4d\x01\x73\x5f\x76\xa0\xa2\xa3\x1f\x28\x72\x7c\xe0\x3c\x2e\xaa\x52\xc4\x70\x49\x23\x1c\x66\x8b\x69\x8a\x6d\xa7\x95\x57\x44\x9c\xfd\x3b\x08\xda\x32\x4d\x88\x9e\x74\x6c\xc7\x0b\xb3\xfc\x93\x9a\x38\xea\x57\x00\x44\x11\x22\xba\xec\xd6\x9b\x22\x97\x3a\x28\x95\xc0\x59\xcb\xc1\x30\x4b\x2d\xdb\x89\x37\x2e\xa3\x1d\x37\x9f\x1c\x4c\x0c\x4a\xd6\xf2\xbb\x60\xac\x84\x4e\xad\xab\x71\x60\x86\x6f\xaa\x28\x19\xc7\xf9\xd6\x1f\xa5\x4a\x5b\x40\xec\x88\x48\xe8\x5f\xf0\x66\xb3\xd4\xea\x0d\x0e\xb0\xcc\x7a\x76\x44\xdf\x4a\xf4\xa0\x8a\x24\x58\x5e\xe0\x68\xe9\x85\x88\xc9\xbd\xc0\x29\xed\x51\x92\x42\xb1\x9e\xda\xec\xd8\x6b\x61\x9a\x4b\x80\x01\x07\x35\xcb\x6b\x46\xdc\x72\x96\xfb\x3b\x4a\x53\x5f\x7e\x6a\xf7\x69\xf0\xbe\x16\x41\x8d\xdb\x6a\x62\x33\x30\x47\xb3\x2a\x68\x06\xfe\xa9\x9f\x9a\xc4\x65\xc3\xc8\x15\x7c\xba\xd0\xa2\x3a\xd9\x20\x96\x22\x39\xac\x5a\x8f\x48\xc0\x9e\xef\xff\x81\xf5\x11\xa9\xee\x5f\x96\xd5\x3d\x69\x61\x31\xfa\xe8\x32\x90\xc4\xe7\xa0\xf5\xf0\x6b\xb0\xb9\xbf\x17\xf6\xd4\xa8\xa4\xae\x2f\x7b\x47\x84\x89\xf8\xe3\xd1\xd9\xa3\xf6\xa2\xf6\x31\xba\x70\x92\x13\x8d\xa6\xef\x55\xcd\xf5\x92\x28\x26\x3d\xf8\xa3\x41\xd5\x57\x0c\xc4\x20\x3e\x6b\x89\x4e\xc3\x12\xef\x41\x41\xda\x28\x24\x10\x2a\x86\xdc\x2d\x91\x6f\xfc\x0b\xd3\xeb\xf5\x87\xcc\xa3\x17\xb1\xd6\x0c\x7e\x57\xdc\x05\x87\x53\x4d\xbe\x9d\x47\x35\x6f\x72\x52\x2f\x83\x1c\x97\xf6\x22\x8c\x73\xae\x24\x3c\x4b\xb7\xab\x8e\x28\xa3\x79\x07\x17\xdd\xbc\x53\x7d\x9e\xd8\x64\xc7\x38\xc3\x63\xc3\x7a\x98\x51\x07\xb8\x9d\x01\x8b\xad\xcc\xfc\x3e\xad\x50\x63\x87\x4a\xae\xb2\xa7\xaa\xf1\x13\x80\x8c\xfd\x36\x9a\xd2\xc1\xee\xa6\x61\xbb\x0c\xb0\xa5\x3e\xe3\x0b\x70\x62\xfa\xcb\x58\x00";

    const unsigned char key_1[] = "\xca\xc4\x46\xd4\x80\x78\x63\xcf\x8f\x6c\x4b\x2e\xdf\xcf\x4a\xe6";
    const unsigned char nonce_1[] = "\xc2\xb8\x6c\x33\xc4\xa5\x43\x19\x0e\xf6\xae\x31";

    int decryptedtext_len = decrypt_aes_128_gcm(ciphertext_1, 2862, key_1, nonce_1, plaintext);

    if (decryptedtext_len < 0)
    {
        printf("Decryption failed\n");
        return 1;
    }

    printf("Decrypted Data:\n");
    for (int i = 0; i < decryptedtext_len; i++)
    {
        printf("%02x", plaintext[i]);
    }
    printf("\n");

    printf("Decrypted text:\n");
    printf("----------\n");
    printf("%s\n", plaintext);
    printf("----------\n");

    const unsigned char pre_master_secret[] = {
        0xb2, 0xff, 0xb5, 0x48, 0xce, 0x67, 0xa4, 0x6e, 0x3a, 0x40, 0x99, 0x4e, 0x11, 0xf9, 0xd5, 0xd7,
        0xbd, 0xce, 0x9f, 0x34, 0x04, 0xb6, 0x5b, 0x94, 0x71, 0x0f, 0xea, 0x37, 0xfc, 0x61, 0x00, 0xab,
        0x73, 0x4d, 0x79, 0xa0, 0xf8, 0x48, 0x63, 0xc5, 0x24, 0xd5, 0xda, 0x24, 0x8b, 0x59, 0xd0, 0xa9};

    const unsigned char client_random[] = {
        0xcc, 0x81, 0x88, 0x4d, 0x0e, 0xe0, 0x84, 0x8e, 0x9d, 0x72, 0x35, 0xd3, 0x64, 0x4a, 0x89, 0xe0,
        0x76, 0x8b, 0xbf, 0x70, 0x5d, 0x01, 0x2f, 0x87, 0x92, 0xe3, 0x37, 0xd4, 0x50, 0x7a, 0x61, 0x6b};
    const unsigned char server_random[] = {
        0x81, 0x81, 0x2d, 0xce, 0x57, 0xb0, 0x38, 0x17, 0xd0, 0x28, 0xce, 0x00, 0xb6, 0xac, 0x16, 0x6f,
        0x93, 0xb3, 0xd0, 0x02, 0xd5, 0x0a, 0x19, 0x5d, 0xce, 0x22, 0x2b, 0x5a, 0x65, 0xb3, 0x0a, 0x59};

    tls_session_info session_2;
    tls_record_info record_2;
    memcpy(session_2.client_random, client_random, CLIENT_RANDOM_LENGTH);
    memcpy(session_2.server_random, server_random, SERVER_RANDOM_LENGTH);
    memcpy(session_2.pre_master_secret, pre_master_secret, PRE_MASTER_SECRET_LENGTH);

    generate(&session_2, &record_2);

    for (int i = 0; i < HASH_SECRET_LENGTH; ++i)
    {
        printf("%02x", session_2.hash_secret[i]);
    }
    printf("\n");

    for (int i = 0; i < HASH_SEED_LENGTH; ++i)
    {
        printf("%02x", session_2.hash_seed[i]);
    }
    printf("\n");

    p_hash(session_2.hash_secret, HASH_SECRET_LENGTH, session_2.hash_seed, HASH_SEED_LENGTH, session_2.hash_out, HASH_OUT_LENGTH);

    for (int i = 0; i < HASH_OUT_LENGTH; ++i)
    {
        printf("%02x", session_2.hash_out[i]);
    }

    return 0;
}

#endif